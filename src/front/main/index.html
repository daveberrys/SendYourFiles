<link rel="stylesheet" href="popup/popupStyle.css">

<script>
    let selectedPath = null;

    async function loadPopups() {
        // Updated to include the extra subfolder!
        const popups = [
            'sendTo.html',
            'sendTo-Fallback.html',
            'settings.html',
            'credits.html',
            'extra/litterboxTime.html'
        ];

        for (const file of popups) {
            try {
                const response = await fetch(`popup/${file}`);
                const html = await response.text();
                document.body.insertAdjacentHTML('beforeend', html);
                console.log(`Loaded popup: ${file}`);
            } catch (e) {
                console.error(`Failed to load ${file}:`, e);
            }
        }
    }

    window.addEventListener('DOMContentLoaded', loadPopups);

    async function chooseFile() {
        try {
            const path = await window.pywebview.api.pickFile();
            if (path) {
                selectedPath = path;
                const fileName = path.split(/[\\/]/).pop();
                document.getElementById("logs").innerText = `Selected: ${fileName}`;
            }
        } catch (e) {
            console.error("Failed to pick file:", e);
        }
    }

    function showPopup(id) {
        if (id === 'platformPopup' && !selectedPath) {
            showPopup('fallbackPopup');
            return;
        }

        const popup = document.getElementById(id);
        if (popup) {
            popup.style.display = "flex";
        }
    }

    function closePopup(id) {
        const popup = document.getElementById(id);
        if (popup) {
            popup.style.display = "none";
        }
    }

    // This handles the transition specifically for Litterbox
    function startLitterboxFlow() {
        closePopup('platformPopup');
        showPopup('litterboxTimePopup');
    }

    // This is called when the user finally picks a time
    async function litterBoxExpire(timeLabel) {
        closePopup('litterboxTimePopup');

        // Convert "1 Hours" -> "1h", etc. for the API
        const time = timeLabel.split(' ')[0].toLowerCase() + 'h';

        const logPanel = document.getElementById("logs");
        logPanel.innerText = `Uploading to Litterbox (${timeLabel})...`;

        try {
            const result = await window.pywebview.api.uploadTo(selectedPath, 'litterbox', time);
            logPanel.innerText = `Success! Link: ${result}`;
        } catch (e) {
            logPanel.innerText = "Error: Upload failed.";
            console.error(e);
        }
    }

    async function triggerUpload(platform) {
        // If it's litterbox, go to the next popup instead!
        if (platform === 'litterbox') {
            startLitterboxFlow();
            return;
        }

        closePopup('platformPopup');
        const logPanel = document.getElementById("logs");
        logPanel.innerText = `Preparing upload to ${platform}...`;

        try {
            const result = await window.pywebview.api.uploadTo(selectedPath, platform);
            logPanel.innerText = `Success! Link: ${result}`;
        } catch (e) {
            logPanel.innerText = "Error: Could not reach the server.";
            console.error(e);
        }
    }
</script>

<main class="xyCenter">
    <div class="frame">
        <div class="textYap">
            <span class="bigText"> Send Your Files </span>
            <p>Ever wanted to send your files without a restriction?</p>
            <p></p>
        </div>

        <div class="flex" style="gap: 5px;">
            <div class="button" onclick="showPopup('settingsPopup')">Settings</div>
            <div class="button" onclick="showPopup('creditsPopup')">Credits</div>
        </div>
    </div>

    <div class="frame">
        <div class="anotherElem">
            <pre id="logs">No logs yet. Send a file!</pre>
        </div>

        <div class="flex" style="gap: 5px;">
            <div class="button" onclick="chooseFile()">Choose File</div>
            <div class="button" onclick="showPopup('platformPopup')">Upload to...</div>
        </div>
    </div>
</main>